<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <f:view>
        <h:head>
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
            <title>CRV</title>
            <script src="js/jquery.validate.min.js"></script>    
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
            <script src="http://code.jquerygeo.com/jquery.geo-1.1.0.min.js"></script>
            <script>
                $(function () {//Ready

                    var latitud;
                    var longitud;

                    $("#recargaPedidos").on("click","#coordenadas", function () {
                        var codigoPedido = $(this).attr("class");
                        var datos = 'codigoPoblacion='+codigoPedido;


                        //Ponemos el nombre del servlet que nos dará la respuesta y los datos para poder encontrarlas
                        $.getJSON("CompruebaDatos", datos, function (result) {

                            //Recorro el resultado. i->es la clave, field->es el valor 
                            $.each(result, function (i, field) {

                                //Cogemos el select de las provincias y le añadimos los options
                                if (i == "Latitud") {

                                    latitud = field;
                                } else {
                                    longitud = field;
                                }
                            });

                            //Pinto mapa
                            var map = $("#mapa").geomap({
                                center: [longitud, latitud],
                                zoom: 7
                            });
                            $("#mapa").geomap("append",
                                    {
                                        type: "Point",
                                        coordinates: [longitud, latitud] // Coordinates are lng/lat
                                    }
                            );
                        });



                    });//Click boton



                });//Ready
            </script>

        </h:head>
        <h:body>
            <p:messages id="messages" showDetail="true" closable="true">
                <p:autoUpdate />
            </p:messages>
            <h1><h:outputText value="Usuario"/></h1>
            <h1><h:outputText value="#{manageBeanSesion.usuarioLog.nombre}, Bienvenido a su perfil!"/></h1>
            <h2><h:outputText value="Su apellido es: #{manageBeanSesion.usuarioLog.apellido1}
                              #{manageBeanSesion.usuarioLog.apellido2}"/></h2>


            <!--Pedidos-->
            <h2>Ver pedidos</h2>
            <h:panelGroup id="recargaPedidos">
                <c:forEach var="pedido" varStatus="estado" items="#{bUsuarioGestionPedido.listaPedidos}" >

                    #{bUsuarioGestionPedido.setCodigoPedido(pedido.codigoPedido)}

                    <h:panelGroup  rendered="#{bUsuarioGestionPedido.cabeceraPedido()}">
                        <div id="datosPedido" style="border: 1px solid red">
                            <h:outputText value="Telefono "/> <h:outputText value="#{pedido.codigoTelefono.nombre}"/><br></br><br></br>
                            <h:outputText value="Tipo "/> <h:outputText value="#{bUsuarioGestionPedido.saberTipo(pedido.tipo)}"/><br></br><br></br>
                            <h:outputText value="Estado "/> <h:outputText value="#{bUsuarioGestionPedido.conocerEstado(pedido.estado)}"/><br></br><br></br>
                        </div>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{!bUsuarioGestionPedido.cabeceraPedido()}">
                        <div id="pedido" style="border:1px solid black">
                            <h:outputText value="Número pedido "/> <h:outputText value="#{pedido.codigoPedido}"/><br></br><br></br>
                            <h:outputText value="Calle "/> <h:outputText value="#{pedido.codigoDireccion.nombre}"/><br></br><br></br>
                            <h:outputText value="Fecha "/> <h:outputText value="#{pedido.fecha}"/><br></br><br></br>    
                        </div> 
                        <div id="datosPedido" style="border: 1px solid red">
                            <h:graphicImage url="imagenes/FotosTelefono/#{bUsuarioGestionPedido.conocerFoto(pedido.codigoTelefono)}" width="50" height="50" /> 

                            <h:outputText value="#{pedido.codigoTelefono.nombre}"/><br></br><br></br>
                            <h:outputText value="Telefono "/> <h:outputText value="#{pedido.codigoTelefono.nombre}"/><br></br><br></br>
                            <h:outputText value="Tipo "/> <h:outputText value="#{bUsuarioGestionPedido.saberTipo(pedido.tipo)}"/><br></br><br></br>
                            <h:outputText value="Estado "/> <h:outputText value="#{bUsuarioGestionPedido.conocerEstado(pedido.estado)}"/><br></br><br></br>
                        </div>
                    </h:panelGroup>
                    <h:form>
                        <h:commandButton  value="Cambiar estado" action="#{bUsuarioGestionPedido.cambiarEstado(pedido.codigo)}">
                            <f:ajax  event="action" render=":result" />
                        </h:commandButton>
                    </h:form>


                    <input type="button" id="coordenadas" class="#{pedido.codigoPoblacion}" value="Coordenadas"/>


                    <h:form>
                        <h:commandButton  value="Ver pdf estado" action="#{bUsuarioGestionPedido.generarPdf(pedido.codigoPedido)}"/>
                    </h:form>


                    #{bUsuarioGestionPedido.setCodigoPedidoAnterior(pedido.codigoPedido)}
                </c:forEach>
            </h:panelGroup>
            <h:form id="result" >

                <h:panelGroup id="cambiaEstado" rendered="#{bUsuarioGestionPedido.estado}">
                    <div id="dialog" style="border: 1px solid blue">
                        <h:selectOneMenu value="#{bUsuarioGestionPedido.estadoNuevo}">  
                            <f:selectItems value="#{bUsuarioGestionPedido.listaEstados}"/>
                        </h:selectOneMenu>
                    </div>
                    <p:commandButton value="Cambiar estado" action="#{bUsuarioGestionPedido.modificarEstado()}" update="recargaPedidos result messages"/>

                </h:panelGroup> 
            </h:form>   


            <!--Ventana modal cambiar ubicacion-->
            <h:form id="result2" >
                <h:panelGroup rendered="#{bUsuarioGestionPedido.ubicacion}" >
                    <div id="ubicacion" style="border: 1px solid pink">
                        <p:selectOneMenu id="poblacion" value="#{bUsuarioGestionPedido.codigoPoblacion}" editable="false"  filter="true" filterMatchMode="startsWith" caseSensitive="false" required="true">
                            <f:selectItems value="#{bUsuarioGestionPedido.listaPoblaciones}" />
                        </p:selectOneMenu>
                    </div>

                    <p:commandButton value="Cambiar ubicacion" action="#{bUsuarioGestionPedidos.modificarUbicacion()}" update="recargaPedidos result2 messages" />
                </h:panelGroup>

            </h:form>  

            <div id="mapa" style="height: 500px">


            </div>

        </h:body>
    </f:view>    
</html>
